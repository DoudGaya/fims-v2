generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

model User {
  id                     String       @id @default(cuid())
  email                  String       @unique
  displayName            String?
  role                   String       @default("agent")
  createdAt              DateTime     @default(now())
  updatedAt              DateTime     @updatedAt
  firstName              String?
  isActive               Boolean      @default(true)
  lastLogin              DateTime?
  lastName               String?
  password               String?
  phoneNumber            String?
  isVerified             Boolean      @default(false)
  passwordChangeRequired Boolean      @default(false)
  passwordResetToken     String?
  passwordResetExpiry    DateTime?
  // SSO Fields
  ssoProviderId          String?      // e.g., "google_123456789"
  ssoProvider            String?      // "google" or "microsoft"
  ssoEmail               String?      // email from SSO provider
  lastSSOLogin           DateTime?    // track SSO login history
  isSSOEnabled           Boolean      @default(false) // flag to allow SSO for user
  createdAgents          Agent[]      @relation("CreatedByUser")
  agent                  Agent?
  farmers                Farmer[]
  userRoles              user_roles[]
  userPermissions        UserPermission[]
  ssoAuditLogs           SSOAuditLog[]

  @@map("users")
}

model Agent {
  id                     String       @id @default(cuid())
  userId                 String       @unique
  nin                    String       @unique
  firstName              String
  middleName             String?
  lastName               String
  dateOfBirth            DateTime?
  gender                 String?
  maritalStatus          String?
  employmentStatus       String?
  photoUrl               String?
  phone                  String       @unique
  email                  String       @unique
  whatsAppNumber         String?
  alternativePhone       String?
  address                String?
  city                   String?
  state                  String?
  localGovernment        String?
  ward                   String?
  pollingUnit            String?
  latitude               Float?
  longitude              Float?
  bankName               String?
  accountName            String?
  accountNumber          String?
  bvn                    String?      @unique
  assignedState          String?
  assignedLGA            String?
  assignedWards          String[]
  employmentType         String?
  salary                 Float?
  commissionRate         Float?
  startDate              DateTime?
  endDate                DateTime?
  totalFarmersRegistered Int          @default(0)
  activeAssignments      Int          @default(0)
  performanceRating      Float?
  registrationDate       DateTime     @default(now())
  activationDate         DateTime?
  status                 String       @default("pending")
  activationToken        String?
  activationTokenExpiry  DateTime?
  passwordResetToken     String?
  passwordResetExpiry    DateTime?
  createdAt              DateTime     @default(now())
  updatedAt              DateTime     @updatedAt
  createdByUserId        String?
  createdBy              User?        @relation("CreatedByUser", fields: [createdByUserId], references: [id])
  user                   User         @relation(fields: [userId], references: [id], onDelete: Cascade)
  attendanceRecords      Attendance[]

  @@map("agents")
}

model Farmer {
  id               String        @id @default(cuid())
  nin              String        @unique
  firstName        String
  middleName       String?
  lastName         String
  dateOfBirth      DateTime?
  gender           String?
  state            String?
  lga              String?
  maritalStatus    String?
  employmentStatus String?
  phone            String        @unique
  email            String?       @unique
  whatsAppNumber   String?
  address          String?
  ward             String?
  pollingUnit      String?
  latitude         Float?
  longitude        Float?
  bankName         String?
  accountNumber    String?
  bvn              String?       @unique
  registrationDate DateTime      @default(now())
  status           String        @default("Enrolled")
  agentId          String?
  createdAt        DateTime      @default(now())
  updatedAt        DateTime      @updatedAt
  photoUrl         String?
  accountName      String?
  clusterId        String?
  certificates     Certificate[]
  agent            User?         @relation(fields: [agentId], references: [id])
  cluster          Cluster?      @relation(fields: [clusterId], references: [id])
  farms            Farm[]
  referees         Referee[]

  @@index([agentId, createdAt(sort: Desc)]) // Optimize agent queries with date sorting
  @@index([status, createdAt(sort: Desc)]) // Optimize status filtering
  @@index([state, lga]) // Optimize location filtering
  @@index([clusterId]) // Optimize cluster filtering
  @@index([createdAt(sort: Desc)]) // Optimize general listing
  @@map("farmers")
}

model Farm {
  id                  String   @id @default(cuid())
  farmSize            Float?
  primaryCrop         String?
  secondaryCrop       String[]
  produceCategory     String?
  farmOwnership       String?
  farmState           String?
  farmLocalGovernment String?
  farmingSeason       String?
  farmWard            String?
  farmPollingUnit     String?
  farmingExperience   Int?
  farmLatitude        Float?
  farmLongitude       Float?
  farmPolygon         Json?
  soilType            String?
  soilPH              Float?
  soilFertility       String?
  farmCoordinates     Json?
  coordinateSystem    String?  @default("WGS84")
  farmArea            Float?
  farmElevation       Float?
  year                Float?
  yieldSeason         String?
  crop                String?
  quantity            Float?
  cropVariety         String?
  landforms           String?
  farmerId            String
  createdAt           DateTime @default(now())
  updatedAt           DateTime @updatedAt
  farmer              Farmer   @relation(fields: [farmerId], references: [id], onDelete: Cascade)

  @@map("farms")
}

model Referee {
  id           String   @id @default(cuid())
  firstName    String
  lastName     String
  phone        String
  relationship String
  farmerId     String
  createdAt    DateTime @default(now())
  updatedAt    DateTime @updatedAt
  farmer       Farmer   @relation(fields: [farmerId], references: [id], onDelete: Cascade)

  @@map("referees")
}

model Certificate {
  id            String    @id @default(cuid())
  certificateId String    @unique
  farmerId      String
  issuedDate    DateTime  @default(now())
  expiryDate    DateTime?
  status        String    @default("active")
  qrCode        String?
  pdfPath       String?
  createdAt     DateTime  @default(now())
  updatedAt     DateTime  @updatedAt
  farmer        Farmer    @relation(fields: [farmerId], references: [id], onDelete: Cascade)

  @@map("certificates")
}

model Analytics {
  id        String   @id @default(cuid())
  metric    String
  value     Json
  date      DateTime @default(now())
  createdAt DateTime @default(now())

  @@map("analytics")
}

model AuditLog {
  id        String   @id @default(cuid())
  action    String
  tableName String
  recordId  String?
  oldValues Json?
  newValues Json?
  userId    String?
  timestamp DateTime @default(now())

  @@map("audit_logs")
}

model State {
  id               String            @id @default(cuid())
  name             String            @unique
  code             String            @unique
  createdAt        DateTime          @default(now())
  updatedAt        DateTime          @updatedAt
  localGovernments LocalGovernment[]

  @@map("states")
}

model LocalGovernment {
  id        String   @id @default(cuid())
  name      String
  code      String?
  stateId   String
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
  state     State    @relation(fields: [stateId], references: [id], onDelete: Cascade)
  wards     Ward[]

  @@unique([name, stateId])
  @@map("local_governments")
}

model Ward {
  id                String          @id @default(cuid())
  name              String
  code              String?
  localGovernmentId String
  createdAt         DateTime        @default(now())
  updatedAt         DateTime        @updatedAt
  pollingUnits      PollingUnit[]
  localGovernment   LocalGovernment @relation(fields: [localGovernmentId], references: [id], onDelete: Cascade)

  @@unique([name, localGovernmentId])
  @@map("wards")
}

model PollingUnit {
  id        String   @id @default(cuid())
  name      String
  code      String?
  wardId    String
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
  ward      Ward     @relation(fields: [wardId], references: [id], onDelete: Cascade)

  @@unique([name, wardId])
  @@map("polling_units")
}

model Cluster {
  id                            String    @id @default(cuid())
  title                         String    @unique
  subCluster                    String?
  description                   String?
  clusterLeadFirstName          String
  clusterLeadLastName           String
  clusterLeadEmail              String
  clusterLeadPhone              String
  clusterLeadNIN                String?
  clusterLeadState              String?
  clusterLeadLGA                String?
  clusterLeadWard               String?
  clusterLeadPollingUnit        String?
  clusterLeadPosition           String?
  clusterLeadAddress            String?
  clusterLeadDateOfBirth        DateTime?
  clusterLeadGender             String?
  clusterLeadMaritalStatus      String?
  clusterLeadEmploymentStatus   String?
  clusterLeadBVN                String?
  clusterLeadBankName           String?
  clusterLeadAccountNumber      String?
  clusterLeadAccountName        String?
  clusterLeadAlternativePhone   String?
  clusterLeadWhatsAppNumber     String?
  totalFarmers                  Int       @default(0)
  totalFarms                    Int       @default(0)
  totalFarmSize                 Float     @default(0)
  isActive                      Boolean   @default(true)
  createdAt                     DateTime  @default(now())
  updatedAt                     DateTime  @default(now()) @updatedAt
  farmers                       Farmer[]

  @@map("clusters")
}

model roles {
  id              String          @id @default(cuid())
  name            String          @unique
  description     String?
  permissions     Json?
  isSystem        Boolean         @default(false)
  isActive        Boolean         @default(true)
  createdAt       DateTime        @default(now())
  updatedAt       DateTime        @default(now()) @updatedAt
  createdBy       String?
  userRoles       user_roles[]
  rolePermissions RolePermission[]
  scopeConfigs    ScopeConfig[]

  @@map("roles")
}

model user_roles {
  id         String   @id @default(cuid())
  userId     String
  roleId     String
  assignedAt DateTime @default(now())
  assignedBy String?
  createdAt  DateTime @default(now())
  role       roles    @relation(fields: [roleId], references: [id], onDelete: Cascade)
  user       User     @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@unique([userId, roleId])
  @@map("user_roles")
}

model Attendance {
  id        String   @id @default(cuid())
  agentId   String
  type      String   // 'check_in' or 'check_out'
  timestamp DateTime
  location  Json     // {latitude, longitude, accuracy, timestamp}
  date      String   // Date string for grouping
  duration  Int?     // Duration in minutes (for check_out records)
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
  agent     Agent    @relation(fields: [agentId], references: [id], onDelete: Cascade)

  @@map("attendance")
}

// SSO Models
model SSOAuditLog {
  id        String   @id @default(cuid())
  userId    String?  // null if user not found
  user      User?    @relation(fields: [userId], references: [id])
  email     String
  provider  String   // "google" or "microsoft"
  status    String   // "success" | "user_not_found" | "sso_disabled" | "error"
  reason    String?  // why it failed
  metadata  Json?    // raw SSO response (sanitized)
  ipAddress String?
  userAgent String?
  createdAt DateTime @default(now())

  @@map("sso_audit_logs")
}

model Permission {
  id              String          @id @default(cuid())
  name            String          @unique        // e.g. "farmers.read"
  description     String?
  category        String?                        // e.g., "farmers", "farms", "agents"
  action          String?                        // e.g., "read", "write", "delete", "create"
  isSystem        Boolean         @default(false)
  isActive        Boolean         @default(true)
  createdAt       DateTime        @default(now())
  updatedAt       DateTime        @updatedAt
  rolePermissions RolePermission[]
  userPermissions UserPermission[]

  @@unique([category, action])
  @@map("permissions")
}

model RolePermission {
  id           String     @id @default(cuid())
  roleId       String
  permissionId String
  role         roles      @relation(fields: [roleId], references: [id], onDelete: Cascade)
  permission   Permission @relation(fields: [permissionId], references: [id], onDelete: Cascade)
  createdAt    DateTime   @default(now())

  @@unique([roleId, permissionId])
  @@map("role_permissions")
}

model UserPermission {
  id           String     @id @default(cuid())
  userId       String
  permissionId String
  user         User       @relation(fields: [userId], references: [id], onDelete: Cascade)
  permission   Permission @relation(fields: [permissionId], references: [id], onDelete: Cascade)
  createdAt    DateTime   @default(now())

  @@unique([userId, permissionId])
  @@map("user_permissions")
}

model ScopeConfig {
  id         String   @id @default(cuid())
  roleId     String
  scope      String   // e.g. "global" | "cluster" | "state" | "lga"
  scopeValue String?  // e.g. clusterId or state code
  role       roles    @relation(fields: [roleId], references: [id], onDelete: Cascade)
  createdAt  DateTime @default(now())
  updatedAt  DateTime @updatedAt

  @@unique([roleId, scope, scopeValue])
  @@map("scope_configs")
}

model PermissionAuditLog {
  id           String   @id @default(cuid())
  action       String   // grant | revoke
  changedBy    String
  userId       String?
  roleId       String?
  permissionId String?
  metadata     Json?
  createdAt    DateTime @default(now())

  @@map("permission_audit_logs")
}
